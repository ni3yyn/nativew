name: Turbo Build APK

on:
  # This enables the manual "Run" button
  workflow_dispatch:
  
  # This enables Auto-Run on Push
  push:
    branches:
      - main   # <--- Verify this matches your branch name (main or master)
    paths-ignore:
      - 'README.md'   # Don't build if you only change documentation
      - '.gitignore'

      jobs:
        build:
          name: ðŸš€ Build Android AAB
          runs-on: ubuntu-latest
          steps:
            - name: ðŸ— Checkout Repository
              uses: actions/checkout@v4
      
            - name: â˜• Setup JDK 17
              uses: actions/setup-java@v4
              with:
                distribution: 'temurin'
                java-version: '17'
      
            - name: ðŸŸ¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                node-version: 20.x
                cache: 'npm'
      
            - name: ðŸ“¦ Install Dependencies
              run: |
                rm -f package-lock.json
                npm install
      
            # NEW STEP: Decode Keystore
            # You must base64 encode your .keystore file and add it to GitHub Secrets
            # Command to encode: base64 -i wathiq-release.keystore -o keystore_base64.txt
            - name: ðŸ” Decode Keystore
              env:
                ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
                run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.keystore

            # CHANGED: Build AAB using Gradle directly
            - name: ðŸ“± Build AAB
              working-directory: android
              env:
                # Define these in GitHub Repo -> Settings -> Secrets and variables -> Actions
                MYAPP_UPLOAD_STORE_FILE: release.keystore # Matches the filename above
                MYAPP_UPLOAD_STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
                MYAPP_UPLOAD_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
                MYAPP_UPLOAD_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
              run: ./gradlew bundleRelease
      
            # CHANGED: Upload AAB
            - name: ðŸ“¤ Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                name: wathiq-release-aab
                path: android/app/build/outputs/bundle/release/app-release.aab