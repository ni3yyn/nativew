name: Turbo Build APK

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.gitignore'

jobs:
  build:
    name: ðŸš€ Build Android APK
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout Code
      - name: ðŸ— Checkout Repository
        uses: actions/checkout@v4

      # 2. Setup Java (Required for Android Gradle)
      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Gradle Caching (The Speed Booster)
      - name: ðŸ˜ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-v5-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-v5-

      # 4. Setup Node & NPM Cache
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      # 5. Install Global Tools
      - name: ðŸ›  Install EAS CLI
        run: npm install -g eas-cli

      # 6. Install Dependencies (Robust Mode)
      - name: ðŸ“¦ Install Dependencies
        run: |
          rm -f package-lock.json
          npm install

      # 7. ðŸ†• CRITICAL: Apply Keyboard Fix BEFORE Build
      - name: ðŸ”§ Apply Android Keyboard Fix
        run: |
          # Update app.json with correct keyboard settings
          npm pkg set expo.android.softwareKeyboardLayoutMode=resize
          npm pkg set 'expo.android.windowSoftInputMode'='adjustResize'
          
          # Create the correct styles.xml for Android
          mkdir -p android/app/src/main/res/values
          
          cat > android/app/src/main/res/values/styles.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources xmlns:tools="http://schemas.android.com/tools">
            
            <!-- Add color definitions -->
            <color name="colorPrimary">#5A9C84</color>
            <color name="splashscreen_background">#1A2D27</color>
            
            <style name="AppTheme" parent="Theme.AppCompat.DayNight.NoActionBar">
              <!-- CRITICAL: These two lines fix the keyboard covering issue -->
              <item name="android:fitsSystemWindows">true</item>
              <item name="android:windowSoftInputMode">adjustResize</item>
              
              <!-- Your existing items -->
              <item name="android:enforceNavigationBarContrast" tools:targetApi="29">false</item>
              <item name="android:navigationBarColor">@android:color/transparent</item>
              <item name="android:editTextBackground">@drawable/rn_edit_text_material</item>
              <item name="colorPrimary">@color/colorPrimary</item>
              <item name="android:statusBarColor">#1A2D27</item>
              
              <!-- Add these for proper window behavior -->
              <item name="android:windowTranslucentStatus">true</item>
              <item name="android:windowTranslucentNavigation">true</item>
              <item name="android:windowDrawsSystemBarBackgrounds">true</item>
              <item name="android:windowFullscreen">false</item>
            </style>

            <style name="Theme.App.SplashScreen" parent="Theme.SplashScreen">
              <item name="windowSplashScreenBackground">@color/splashscreen_background</item>
              <item name="windowSplashScreenAnimatedIcon">@drawable/splashscreen_logo</item>
              <item name="postSplashScreenTheme">@style/AppTheme</item>
              <item name="android:windowFullscreen">false</item>
              <item name="android:windowSplashScreenBehavior">icon_preferred</item>
            </style>
          </resources>
          EOF
          
          # Apply fix to AndroidManifest.xml if it exists
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
            # Ensure windowSoftInputMode is set correctly
            sed -i 's/android:windowSoftInputMode="[^"]*"/android:windowSoftInputMode="adjustResize"/g' android/app/src/main/AndroidManifest.xml
            # Add fitsSystemWindows if missing
            if ! grep -q 'fitsSystemWindows' android/app/src/main/AndroidManifest.xml; then
              sed -i '/android:name=".MainActivity"/a \        android:fitsSystemWindows="true"' android/app/src/main/AndroidManifest.xml
            fi
          fi

      # 8. Build the APK
      - name: ðŸ“± Build APK (Local Mode)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=1024m"
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "Error: EXPO_TOKEN is missing! Check your GitHub Secrets."
            exit 1
          fi
          
          # Prebuild first to ensure Android folder exists
          npx expo prebuild --platform android --clean
          
          # Re-apply the styles.xml after prebuild (it might get overwritten)
          cat > android/app/src/main/res/values/styles.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources xmlns:tools="http://schemas.android.com/tools">
            <color name="colorPrimary">#5A9C84</color>
            <color name="splashscreen_background">#1A2D27</color>
            
            <style name="AppTheme" parent="Theme.AppCompat.DayNight.NoActionBar">
              <item name="android:fitsSystemWindows">true</item>
              <item name="android:windowSoftInputMode">adjustResize</item>
              <item name="android:enforceNavigationBarContrast" tools:targetApi="29">false</item>
              <item name="android:navigationBarColor">@android:color/transparent</item>
              <item name="android:editTextBackground">@drawable/rn_edit_text_material</item>
              <item name="colorPrimary">@color/colorPrimary</item>
              <item name="android:statusBarColor">#1A2D27</item>
              <item name="android:windowTranslucentStatus">true</item>
              <item name="android:windowTranslucentNavigation">true</item>
              <item name="android:windowDrawsSystemBarBackgrounds">true</item>
              <item name="android:windowFullscreen">false</item>
            </style>

            <style name="Theme.App.SplashScreen" parent="Theme.SplashScreen">
              <item name="windowSplashScreenBackground">@color/splashscreen_background</item>
              <item name="windowSplashScreenAnimatedIcon">@drawable/splashscreen_logo</item>
              <item name="postSplashScreenTheme">@style/AppTheme</item>
              <item name="android:windowFullscreen">false</item>
              <item name="android:windowSplashScreenBehavior">icon_preferred</item>
            </style>
          </resources>
          EOF
          
          # Run the build
          eas build --local --clear-cache --platform android --profile preview --non-interactive --output ./wathiq.apk

      # 9. Upload Result
      - name: ðŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wathiq-release-apk
          path: wathiq.apk